<%- include('../partials/headercode.ejs') %>

    <style>
        .btn-custom {
            flex: 1;
            /* Make the buttons take equal space */
            margin: 0;
            /* Adjust the horizontal spacing */
            height: 40px;
            /* Set a fixed height for both buttons */
            display: flex;
            padding: 0px;
            align-items: center;
            /* Center the text vertically */
            justify-content: center !important;
            /* Center the text horizontally */
            white-space: nowrap;
            /* Prevent text from wrapping */
        }

        .modal-header {
            display: flex;
            justify-content: flex-start;
        }

        .btn-close {
            margin-left: 0;
        }


        /* Base styles for the table */
        .swal2-table {
            width: 100%;
            border-collapse: collapse;
        }

        .swal2-table th,
        .swal2-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        /* Media query for mobile devices */
        @media (max-width: 600px) {
            .swal2-table {
                font-size: 12px;
                /* Adjust the font size for mobile */
            }

            .swal2-table th,
            .swal2-table td {
                padding: 4px;
                /* Adjust the padding for mobile */
            }

            .swal2-modal .swal2-title {
                font-size: 18px;
                /* Adjust the modal title size */
            }

            .swal2-modal {
                width: 90%;
                /* Adjust the modal width */
            }
        }
    </style>

    <body>
        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar  ">
            <div class="layout-container">

                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">

                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">

                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">


                                    <h4 class="py-3 mb-4">
                                        My Subscription
                                    </h4>

                                    <div class="row">
                                        <div class="col-md-12">

                                            <div class="card mb-4">
                                                <!-- Current Plan -->
                                                <h5 class="card-header">Current Plan</h5>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-1">
                                                            <div class="mb-4">
                                                                <h6 class="mb-2">Your Current Plan is <span
                                                                        id="plan_name"></span></h6>
                                                                <p>A simple start for everyone</p>
                                                            </div>
                                                            <div class="mb-4">
                                                                <h6 class="mb-2">Active until <span
                                                                        class="plan_expiry"></span></h6>
                                                                <p>We will send you a notification upon Subscription
                                                                    expiration</p>
                                                            </div>

                                                        </div>
                                                        <div class="col-md-6 mb-1">
                                                            <div class="alert alert-warning mb-4" role="alert">
                                                                <h6 class="alert-heading mb-1">Your current plan is
                                                                    going to expire on
                                                                </h6>
                                                                <span class="plan_expiry"></span>
                                                            </div>
                                                            <div class="plan-statistics">
                                                                <div class="d-flex justify-content-between">
                                                                    <span class="fw-medium mb-2">Days</span>
                                                                    <span class="fw-medium mb-2"><span
                                                                            id="remaining_days"></span> of <span
                                                                            id="plan_duration"></span> Days</span>
                                                                </div>
                                                                <div class="progress">
                                                                    <div class="progress-bar" role="progressbar"
                                                                        aria-valuenow="20" aria-valuemin="0"
                                                                        aria-valuemax="100">
                                                                    </div>
                                                                </div>

                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <button class="btn btn-primary me-2 mt-2"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#pricingModal">Upgrade Plan</button>
                                                            <!-- <button
                                                                class="btn btn-label-secondary cancel-subscription mt-2">Cancel
                                                                Subscription</button> -->
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- /Current Plan -->
                                            </div>

                                            <div class="card">
                                                <!-- Billing History -->
                                                <h5 class="card-header border-bottom">Billing History</h5>
                                                <div class="card-datatable table-responsive">
                                                    <table class="invoice-list-table table border-top">
                                                        <thead>
                                                            <tr>
                                                                <th>#ID</th>
                                                                <th>Plan</th>
                                                                <th>Total</th>
                                                                <th class="text-truncate">Issued Date</th>
                                                                <th class="text-truncate">Expiry Date</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="billing_history">

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <!--/ Billing History -->
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modal -->
                                    <!-- Pricing Modal -->
                                    <div class="modal fade" id="pricingModal" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-xl modal-simple modal-pricing">
                                            <div class="modal-content p-0 p-md-2 p-xl-3">
                                                <div class="modal-body px-2 px-md-4">
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                    <!-- Pricing Plans -->
                                                    <div class="rounded-top">
                                                        <h2 class="text-center mb-2 mt-0 px-2">Find the right
                                                            plan
                                                            for your
                                                            site</h2>
                                                        <p class="text-center pb-3 px-2"> Get started with us - it's
                                                            perfect
                                                            for
                                                            individuals and teams. Choose a subscription plan that meets
                                                            your needs.
                                                        </p>

                                                        <!-- All Plans -->
                                                        <div class="row mx-0 gy-3" id="availablePlans"></div>
                                                    </div>
                                                </div>
                                                <!--/ Pricing Plans -->
                                            </div>
                                        </div>
                                    </div>
                                    <!--/ Pricing Modal -->

                                    <!--/ Modal -->

                                    <!--  Model summary and payment mode -->
                                    <div class="modal fade" id="SummaryModal" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-xl modal-simple modal-pricing">
                                            <div class="modal-content p-0 p-md-2 p-xl-3">
                                                <div class="modal-body px-2 px-md-4">
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                    <div class="rounded-top">
                                                        <div class="row mx-0 gy-3">
                                                            <div class="col-lg mb-md-0">
                                                                <div class="card border rounded shadow-none">
                                                                    <div class="card-body position-relative">
                                                                        <div class="my-1">
                                                                            <strong>MODE OF PAYMENT</strong>
                                                                        </div>
                                                                        <div class="card">
                                                                            <div class="row">
                                                                                <!-- <div class="col-md-4">
                                                                                    <h5 class="card-header mx-2"><input
                                                                                            type="radio"
                                                                                            name="paymentoption"
                                                                                            value="cash"
                                                                                            class="px-2">Cash</h5>
                                                                                </div> -->
                                                                                <div class="col-md-4 ">
                                                                                    <h5 class="card-header mx-2"><input
                                                                                            type="radio"
                                                                                            name="paymentoption"
                                                                                            value="upi"
                                                                                            id="upiOption">UPI</h5>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <div class="my-3 pt-2">
                                                                            <strong>Terms and Conditions</strong>
                                                                        </div>
                                                                        <div class="card mb-4">
                                                                            <div class="row">
                                                                                <div>
                                                                                    <div class="card-header"><input
                                                                                            type="checkbox"
                                                                                            name="checkbox"
                                                                                            id="agreeTerms" value="cash"
                                                                                            required>please read these
                                                                                        terms and conditions before
                                                                                        proceeding for the
                                                                                        payment..............................
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>


                                                            <!-- second box -->
                                                            <div class="col-lg mb-md-0 ">
                                                                <div class="card border rounded shadow-none mb-4 pb-4">
                                                                    <div class="card-body position-relative">
                                                                        <div class="my-3 pt-3">
                                                                            <h3>PLAN SUMMARY</h3>
                                                                        </div>
                                                                        <strong class="card-title text-capitalize mb-3">
                                                                        </strong>
                                                                        <div class="d-flex">
                                                                            <sup
                                                                                class="h6 pricing-currency mt-3 mb-0 me-1 text-primary">₹</sup>
                                                                            <h1 class="display-4 mb-2 pb-2 text-primary"
                                                                                id="plan-price">

                                                                            </h1>
                                                                        </div>
                                                                        <p id="plan-description">
                                                                        </p>

                                                                        <div>GST: 18%</div>
                                                                        <div id="totalamt">Total amount : GST + Plan
                                                                            charge</div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- /second box -->
                                                        </div>

                                                        <div class="d-flex justify-content-center">
                                                            <button type="button" class="btn btn-primary d-grid w-30"
                                                                id="proceedToPayBtn" data-bs-dismiss="modal"
                                                                disabled>Proceed to Pay</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- /Model summary and payment mode -->

                                    </div>
                                    <!-- / Content -->

                                    <div class="content-backdrop fade"></div>
                                </div>
                                <!-- Content wrapper -->
                            </div>
                            <!-- / Layout page -->

                            <!-- Overlay -->
                            <div class="layout-overlay layout-menu-toggle"></div>


                            <!-- Drag Target Area To SlideIn Menu On Small Screens -->
                            <div class="drag-target"></div>

                    </div>
                    <!-- / Layout wrapper -->

                    <%- include('../partials/footercode.ejs') %>
                        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
                        <script>
                            $(document).ready(function () {

                                const orgId = '<%=orgId%>';

                                $.getJSON('/api/v2/subscriptions/plans', function (data) {
                                    const plans = data.data;

                                    $.each(plans, function (index, plan) {
                                        const planDuration = plan.plan_duration;
                                        const planPrice = plan.plan_price;
                                        const dailyCharge = planPrice / planDuration;

                                        const planCard = `
                                            <div class="col-lg mb-md-0 mb-4">
                                                <div class="card border rounded shadow-none">
                                                    <div class="card-body position-relative">
                                                    <div class="my-3 pt-2">
                                                        <strong>${plan.plan_duration} Days</strong>
                                                    </div>
                                                    <div class="d-flex">
                                                        <sup class="h6 pricing-currency mt-3 mb-0 me-1 text-primary">₹</sup>
                                                        <h1 class="display-4 mb-0 text-primary">${plan.plan_price}</h1>
                                                    </div>
                                                    <p> Upgrade Your Plan for the Next ${plan.plan_duration} Days for Just ₹${plan.plan_price} ! Enjoy all the benefits for a daily cost of only <strong>₹ ${dailyCharge.toFixed(0)}</strong></p>
                                                    <button type="button" class="btn btn-primary d-grid w-100 btn-plans" data-bs-dismiss="modal" data-duration="${plan.plan_duration}" data-price="${plan.plan_price}" data-planid="${plan.plan_id}">Get Started</button>
                                                    </div>
                                                </div>
                                            </div>`;
                                        $('#availablePlans').append(planCard);

                                    })
                                });

                                $(document).on('click', '.btn-plans', function () {
                                    // Get the plan ID from the button's data attribute
                                    const planId = $(this).data('planid');

                                    // Fetch the plan details
                                    $.getJSON(`/api/v2/subscriptions/plans/${planId}`, function (data) {
                                        planDetails = data.data;

                                        $('#plan-price').text(planDetails.plan_price);
                                        $('#plan-description').text(planDetails.plan_description);

                                        // Set the plan ID as a data attribute on the summary modal
                                        $('#SummaryModal').data('planid', planId);

                                        // Show the summary modal
                                        $('#SummaryModal').modal('show');

                                    });
                                });

                                $(document).on('click', '#proceedToPayBtn', function () {

                                    let orgName
                                    let orgEmail
                                    let orgPhone

                                    // Fetch organisation details
                                    $.ajax({
                                        url: `/api/v2/organisation/${orgId}`,
                                        type: 'GET',
                                        success: function (response) {
                                            const orgData = response.data;
                                            console.log(response);

                                            orgName = orgData.org_name;
                                            orgEmail = orgData.org_email;
                                            orgPhone = orgData.org_telephone
                                        }
                                    })

                                    // Get the plan ID from the summary modal's data attribute
                                    const planId = $('#SummaryModal').data('planid');

                                    // Now you can use planId to make the API call
                                    $.ajax({
                                        url: `/api/v2/subscriptions/create-order`,
                                        type: 'POST',
                                        data: JSON.stringify({
                                            planId: planId,
                                            orgId: orgId,
                                        }),
                                        contentType: 'application/json',
                                        success: function (response) {
                                            const orderData = response.data;
                                            var protocol = window.location.protocol;
                                            var host = window.location.host;

                                            // Create a new Razorpay instance
                                            var options = {
                                                "key": "rzp_test_U7vPxyslKE1fpz", // Replace with your Razorpay key
                                                "amount": orderData.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise or ₹500.
                                                "currency": "INR",
                                                "name": "DAWA.AI",
                                                "description": "Test Transaction",
                                                "image": protocol + "//" + host + "/img/login-2/dawa%20logo-02%201.png",
                                                "order_id": orderData.id, // This is a sample Order ID. Pass the `id` obtained in the response of the previous step.
                                                "handler": function (response) {
                                                    // Handle the payment success
                                                    fetch('/api/v2/subscriptions/verify-payment', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json'
                                                        },
                                                        body: JSON.stringify({
                                                            razorpay_order_id: response.razorpay_order_id,
                                                            razorpay_payment_id: response.razorpay_payment_id,
                                                            razorpay_signature: response.razorpay_signature,
                                                            orgId: orgId,
                                                            planId: planId,
                                                            orderId: orderData.id
                                                        })
                                                    }).then(function (response) {
                                                        response.json().then(function (data) {
                                                            console.log('response', data);
                                                            const billId = data.billId;
                                                            console.log(billId);
                                                            fetch(`/api/v2/subscriptions/bill/${billId}`, {
                                                                method: 'GET',
                                                                headers: {
                                                                    'Content-Type': 'application/json'
                                                                },
                                                            }).then(function (response) {
                                                                response.json().then(function (data) {
                                                                    console.log(data);
                                                                    const billData = data.data;

                                                                    let plan_end = new Date(billData.end_date);
                                                                    plan_end = plan_end.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                                                                    let plan_start = new Date(billData.start_date);
                                                                    plan_start = plan_start.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                                                                    return Swal.fire({
                                                                        html: `
                                                                            <div>
                                                                                <div class="modal-header d-flex justify-content-start">
                                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                                </div>
                                                                                <h2 class="text-center mt-2 px-2">Thank You For Subscribing!</h2>
                                                                                <p class="text-center pb-3 px-2"> We have sent a confirmation mail on your email with the receipt.</p>
                                                                                <div class="card-body">
                                                                                    <div class="table-responsive text-nowrap">
                                                                                        <table class="table table-bordered swal2-table">
                                                                                            <tbody>
                                                                                                <tr>
                                                                                                    <td>Plan Name</td>
                                                                                                    <td>${billData.plan_name}</td>
                                                                                                </tr>
                                                                                                <tr>
                                                                                                    <td>Start Date</td>
                                                                                                    <td>${plan_start}</td>
                                                                                                </tr>
                                                                                                <tr>
                                                                                                    <td>Next Billing Date</td>
                                                                                                    <td>${plan_end}</td>
                                                                                                </tr>
                                                                                                <tr>
                                                                                                    <td>Amount Charged</td>
                                                                                                    <td>${billData.amount}</td>
                                                                                                </tr>
                                                                                                <tr>
                                                                                                    <td>Subscription Id</td>
                                                                                                    <td>${billData.bill_id}</td>
                                                                                                </tr>
                                                                                            </tbody>
                                                                                        </table>
                                                                                        <div class="d-flex justify-content-center mt-4">
                                                                                            <div class="d-flex flex-column flex-md-row justify-content-center">
                                                                                                <div class="p-1">
                                                                                                    <button id="downloadButton" class="btn btn-primary btn-label-secondary btn-custom d-grid w-100 mb-3 px-3" type="button" onclick="downloadReceipt(${billData.bill_id})">Download</button>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        `,
                                                                        showConfirmButton: false, // Disable default "OK" button
                                                                        width: '700px', // Increase the width
                                                                    });



                                                                });
                                                            });


                                                        });
                                                    })
                                                        .catch((error) => {
                                                            console.error('Error:', error);
                                                        });
                                                },
                                                "prefill": {
                                                    "name": orgName,
                                                    "email": orgEmail,
                                                    "contact": orgPhone
                                                },
                                                "notes": {
                                                    "address": "note value"
                                                },
                                                "theme": {
                                                    "color": "#696cff"
                                                }
                                            };
                                            var rzp1 = new Razorpay(options);
                                            rzp1.on('payment.failed', function (response) {
                                                // Handle payment failure
                                                fetch('/api/v2/subscriptions/record-failure', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json'
                                                    },
                                                    body: JSON.stringify({
                                                        razorpay_order_id: response.error.metadata.order_id,
                                                        razorpay_payment_id: response.error.metadata.payment_id,
                                                        orgId: orgId,
                                                        planId: planId,
                                                        orderId: orderData.id, // Include order ID
                                                        error_code: response.error.code,
                                                        error_description: response.error.description
                                                    })
                                                }).then(res => res.json()).then(data => {
                                                    console.log(data.message);
                                                });
                                            });
                                            rzp1.open();
                                        }
                                    });
                                });


                                $.get(`/api/subscription/billinghistory/${orgId}`, function (data) {
                                    let items = data.data;
                                    for (var i = 0; i < items.length; i++) {

                                        let plan_end = new Date(items[i].end_date);
                                        plan_end = plan_end.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                                        let plan_start = new Date(items[i].start_date);
                                        plan_start = plan_start.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                                        htmlData = `
                                                <tr>
                                                    <td>${items[i].bill_id}</td>
                                                    <td>${items[i].plan_name}</td>
                                                    <td><strong>${items[i].amount}</strong></td>
                                                    <td>${plan_start}</td>
                                                    <td>${plan_end}</td>
                                                </tr>
                                                `
                                        $('#billing_history').append(htmlData);
                                    }
                                });

                                $.get(`/api/subscription/currentplan/${orgId}`, function (data) {

                                    $('#plan_name').text(data.data[0].plan_name);

                                    let current_date = new Date();
                                    let plan_end = new Date(data.data[0].end_date);
                                    let formattedDate = plan_end.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                                    $('.plan_expiry').text(formattedDate);

                                    let plan_duration = data.data[0].plan_duration;
                                    $('#plan_duration').text(plan_duration);


                                    let remaining_days = ((plan_end - current_date) / (1000 * 60 * 60 * 24));
                                    $('#remaining_days').text(Math.floor(remaining_days));

                                    let percentage = Math.floor((remaining_days / plan_duration) * 100);

                                    $('.progress-bar').css('width', percentage + '%').attr('aria-valuenow', percentage);

                                });

                                // Cancel Subscription
                                $('.cancel-subscription').on('click', function () {
                                    Swal.fire({
                                        title: 'Are you sure?',
                                        text: "You won't be able to revert this!",
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonColor: '#3085d6',
                                        cancelButtonColor: '#d33',
                                        confirmButtonText: 'Yes, cancel it!'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            Swal.fire(
                                                'Cancelled!',
                                                'Your subscription has been cancelled.',
                                                'success'
                                            )
                                        }
                                    })
                                });


                                // Pricing Modal
                                $('#pricingModal').on('show.bs.modal', function (e) {
                                    $('body').addClass('modal-open');
                                });
                            })

                            function downloadReceipt(billId) {
                                fetch(`/api/v2/subscription/receipt/${billId}/pdf`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Network response was not ok');
                                        }
                                        return response.blob();
                                    })
                                    .then(blob => {
                                        const url = window.URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = 'receipt.pdf';
                                        document.body.appendChild(a);
                                        a.click();
                                        a.remove();
                                    })
                                    .catch(error => {
                                        console.error('There has been a problem with your fetch operation:', error);
                                    });
                            }



                            // proceedToPayBtn to successful Subscription page
                            // $(document).ready(function () {
                            //     $('#proceedToPayBtn').on('click', function () {
                            //         const isCashSelected = $('input[name="paymentoption"]:checked').val() === 'cash';
                            //         const isUPISelected = $('input[name="paymentoption"]:checked').val() === 'upi';
                            //         function subsriptionSuccessful() {

                            //         }
                            //         if (isCashSelected) {

                            //             subsriptionSuccessful();
                            //             // Close the SweetAlert modal when the custom close button is clicked
                            //             $(document).on('click', '.btn-close', function () {
                            //                 Swal.close();
                            //             });
                            //         } else if (isUPISelected) {
                            //             Swal.fire({
                            //                 html: `
                            //             <div class="container">
                            //                 <div class="row">
                            //                     <div class="col-md-6">
                            //                         <h5>Select Payment Method</h5>
                            //                         <div class="mb-3">
                            //                             <label for="paymentMethod" class="form-label">Payment Method</label>
                            //                             <select class="form-select" id="paymentMethod">
                            //                                 <option value="gpay">GPay</option>
                            //                                 <option value="paytm">Paytm</option>
                            //                                 <option value="phonepe">PhonePe</option>
                            //                             </select>
                            //                         </div>
                            //                         <div class="mt-3">
                            //                             <label for="upiId" class="form-label">Enter UPI ID</label>
                            //                             <input type="text" class="form-control" id="upiId" placeholder="Enter your UPI ID">
                            //                         </div>
                            //                     </div>
                            //                     <div class="col-md-6 text-center">
                            //                         <h5>Scan QR Code</h5>
                            //                         <img src="https://via.placeholder.com/150" alt="QR Code" class="img-fluid">
                            //                     </div>
                            //                 </div>
                            //                 <div class="mt-4 text-center">
                            //                     <button id="confirmAndPayBtn" class="btn btn-primary btn-label-secondary">Confirm and Pay</button>
                            //                 </div>
                            //             </div>
                            //         `,
                            //                 showConfirmButton: false,
                            //                 width: '800px',
                            //                 padding: '20px'
                            //             });

                            //             $(document).on('click', '#confirmAndPayBtn', function () {
                            //                 subsriptionSuccessful();
                            //                 $(document).on('click', '.btn-close', function () {
                            //                     Swal.close();
                            //                 });
                            //             });

                            //         } else {
                            //             alert('Please select a payment mode to proceed.');
                            //         }
                            //     });
                            // });

                            $(document).ready(function () {
                                function checkConditions() {
                                    const isRadioSelected = $('input[name="paymentoption"]:checked').length > 0;
                                    const isCheckboxChecked = $('#agreeTerms').is(':checked');
                                    $('#proceedToPayBtn').prop('disabled', !(isRadioSelected && isCheckboxChecked));
                                }

                                $('input[name="paymentoption"]').change(checkConditions);
                                $('#agreeTerms').change(checkConditions);
                            });


                        </script>

    </body>

    </html>