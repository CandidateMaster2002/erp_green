<%- include('../partials/headercode.ejs') %>

<head>
    <link rel="stylesheet" href="/vendor/css/pages/page-login-2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div class="mobileview">
        <nav>
            <img src="/img/login-2/menu.png" alt="">
            <img src="/img/login-2/logomobile.png" alt="">
        </nav>
        <div class="login-mv d-flex flex-column align-items-center justify-content-center">
            <div class="form">
                <div id="forgotPasswordMobileFormContent">
                    <!-- Step 1: Enter Email for Mobile -->
                    <% if (!step || step === 'email') { %>
                        <div class="mb-3 text-center">
                            <h4>Forgot Password?</h4>
                            <p>Enter your email to reset your password.</p>
                        </div>
                        <form id="forgotEmailFormMobile" action="/forgot-password/send-otp" method="POST">
                            <div class="mb-3">
                                <label for="emailMobile" class="form-label">Email Address</label>
                                <input type="email" class="form-control w-100" id="emailMobile" name="email"
                                    placeholder="Enter your email" required>
                            </div>
                            <button type="submit" class="btn btn-primary mb-3 w-100" id="sendOtpButtonMobile">Send OTP</button>
                            <% if (typeof error !== 'undefined' && error) { %>
                                <p class="text-danger mt-2"><%= error %></p>
                            <% } %>
                        </form>
                    <% } %>

                    <!-- Step 2: Verify OTP & Set New Password for Mobile (Initially Hidden) -->
                    <% if (step === 'otp') { %>
                        <div class="mb-3 text-center">
                            <h4>Reset Your Password</h4>
                            <p>Enter the OTP sent to <strong><%= email %></strong> and set your new password.</p>
                            <input type="hidden" name="email" value="<%= email %>">
                        </div>
                        <form id="resetPasswordFormMobile" action="/forgot-password/reset-password" method="POST">
                            <input type="hidden" name="email" value="<%= email %>">
                            <div class="mb-3">
                                <label for="otpMobile" class="form-label">OTP</label>
                                <input type="text" class="form-control w-100" id="otpMobile" name="otp"
                                    placeholder="Enter OTP" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPasswordMobile" class="form-label">New Password</label>
                                <div class="password-wrapper position-relative">
                                  <input type="password" class="form-control w-100" id="newPasswordMobile" name="newPassword" placeholder="Enter new password" required>
                                  <i class="fa-solid fa-eye position-absolute toggle-password" toggle="#newPasswordMobile" style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1rem;"></i>
                                </div>
                                <small class="form-text text-muted">
                                    Password must be at least 8 characters, include a number, an uppercase letter, and
                                    a special character.
                                </small>
                                <div id="passwordStrengthMobile" class="mt-1 fw-bold"></div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmNewPasswordMobile" class="form-label">Confirm New Password</label>
                                <div class="password-wrapper position-relative">
                                    <input type="password" class="form-control w-100" id="confirmNewPasswordMobile" name="confirmNewPassword" placeholder="Re-enter new password" required>
                                    <i class="fa-solid fa-eye position-absolute toggle-password" toggle="#confirmNewPasswordMobile" style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1rem;"></i>
                                </div>
                            </div>
                            <div id="passwordMismatchErrorMobile" class="text-danger mb-2" style="display: none;">
                                Passwords do not match.
                            </div>
                            <button type="submit" class="btn btn-primary mb-3 w-100"
                                id="resetPasswordButtonMobile">Reset Password</button>
                        </form>
                        <!-- Resend OTP and Timer for Mobile -->
                        <div class="resend-wrapper text-center mt-2">
                            <form action="/forgot-password/send-otp" method="POST">
                                <input type="hidden" name="email" value="<%= email %>">
                                <p>Didn't receive OTP? <button type="submit" class="btn btn-link p-0 align-baseline"
                                        id="resendOtpButtonMobile">Resend OTP</button></p>
                                <p class="text-center">You can resend OTP after <span id="timerMobile">30</span>
                                    seconds</p>
                            </form>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="left w-50">
            <!-- Carousel content (copy from login-2.ejs) -->
            <div class="carousel slide carousel-dark" id="banner" data-bs-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active" data-bs-interval="8000">
                        <img class="ms-5" src="/img/login-2/cards.png">
                        <p class="mt-2">Change The Way Of Managing Your Store</p>
                    </div>
                    <div class="carousel-item text-center" data-bs-interval="8000">
                        <p>Easy to use Interface to manage all our tasks!</p>
                        <img src="/img/login-2/laptop.png">
                    </div>
                    <div class="carousel-item" data-bs-interval="8000">
                        <p>Next Gen B2B SaaS platform for health care professionals created by IITians & IIMs</p>
                        <img class="w-75 mb-2 ms-5" src="/img/login-2/customer.png">
                        <img class="w-75 mb-2 ms-5" src="/img/login-2/easy.png">
                        <img class="w-75 mb-2 ms-5" src="/img/login-2/sub.png">
                        <img class="w-75 mb-2 ms-5" src="/img/login-2/sales.png">
                    </div>
                </div>
            </div>
        </div>

        <div class="right d-flex flex-column align-items-center justify-content-center">
            <div class="logo">
                <img src="/img/login-2/dawa logo-02 1.png" alt="">
            </div>
            <div class="form">
                <div id="forgotPasswordDesktopFormContent">
                    <!-- Step 1: Enter Email for Desktop -->
                    <% if (!step || step === 'email') { %>
                        <div class="mb-3">
                            <h4>Forgot Password?</h4>
                            <p>Enter your email to reset your password.</p>
                        </div>
                        <form id="forgotEmailFormDesktop" action="/forgot-password/send-otp" method="POST">
                            <div class="mb-3">
                                <label for="emailDesktop" class="form-label">Email Address</label>
                                <input type="email" class="form-control w-100" id="emailDesktop" name="email"
                                    placeholder="Enter your email" required>
                            </div>
                            <button type="submit" class="btn btn-primary d-grid w-100 mb-3"
                                id="sendOtpButtonDesktop">Send OTP</button>
                            <% if (typeof error !== 'undefined' && error) { %>
                                <p class="text-danger mt-2"><%= error %></p>
                            <% } %>
                        </form>
                    <% } %>

                    <!-- Step 2: Verify OTP & Set New Password for Desktop (Initially Hidden) -->
                    <% if (step === 'otp') { %>
                        <div class="mb-3">
                            <h4>Reset Your Password</h4>
                            <p>Enter the OTP sent to <strong><%= email %></strong> and set your new password.</p>
                            <input type="hidden" name="email" value="<%= email %>">
                        </div>
                        <form id="resetPasswordFormDesktop" action="/forgot-password/reset-password" method="POST">
                            <input type="hidden" name="email" value="<%= email %>">
                            <div class="mb-3">
                                <label for="otpDesktop" class="form-label">OTP</label>
                                <input type="text" class="form-control w-100" id="otpDesktop" name="otp"
                                    placeholder="Enter OTP" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPasswordDesktop" class="form-label">New Password</label>
                                <div class="password-wrapper position-relative">
                                  <input type="password" class="form-control w-100" id="newPasswordDesktop" name="newPassword" placeholder="Enter new password" required>
                                  <i class="fa-solid fa-eye position-absolute toggle-password" toggle="#newPasswordDesktop" style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1rem;"></i>
                                </div>
                                <small class="form-text text-muted">
                                    Password must be at least 8 characters, include a number, an uppercase letter, and
                                    a special character.
                                </small>
                                <div id="passwordStrengthDesktop" class="mt-1 fw-bold"></div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmNewPasswordDesktop" class="form-label">Confirm New Password</label>
                                <div class="password-wrapper position-relative">
                                    <input type="password" class="form-control w-100" id="confirmNewPasswordDesktop" name="confirmNewPassword" placeholder="Re-enter new password" required>
                                    <i class="fa-solid fa-eye position-absolute toggle-password" toggle="#confirmNewPasswordDesktop" style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1rem;"></i>
                                </div>
                            </div>
                            <div id="passwordMismatchErrorDesktop" class="text-danger mb-2" style="display: none;">
                                Passwords do not match.
                            </div>
                            <button type="submit" class="btn btn-primary d-grid w-100 mb-3"
                                id="resetPasswordButtonDesktop">Reset Password</button>
                        </form>
                        <!-- Resend OTP and Timer for Desktop -->
                        <div class="text-center mt-2">
                            <form action="/forgot-password/send-otp" method="POST">
                                <input type="hidden" name="email" value="<%= email %>">
                                <p>Didn't receive OTP? <button type="submit" class="btn btn-link p-0 align-baseline"
                                        id="resendOtpButtonDesktop">Resend OTP</button></p>
                                <p class="text-center">You can resend OTP after <span id="timerDesktop">30</span>
                                    seconds</p>
                            </form>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footercode.ejs') %>
    <script>
        // JavaScript for Forgot Password Page

        $(document).ready(function () {

            // --- CUSTOM MODAL IMPLEMENTATION ---
            function showCustomModal(message, type = 'info') {
                const modalHtml = `
                    <div id="customAlertModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-2
                            ${type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-blue-500'}">
                            <div class="text-center">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Notification</h3>
                                <p class="text-gray-700 mb-6">${message}</p>
                                <button id="customModalClose" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    OK
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('body').append(modalHtml);

                // Add Tailwind CSS for the modal
                const tailwindScript = document.createElement('script');
                tailwindScript.src = "https://cdn.tailwindcss.com";
                document.head.appendChild(tailwindScript);

                $('#customModalClose').click(function () {
                    $('#customAlertModal').remove();
                });
            }
            // --- END CUSTOM MODAL ---

            // --- COMMON FUNCTIONS ---
            function updatePasswordStrength(passwordInputId, strengthTextId) {
                const passwordInput = document.getElementById(passwordInputId);
                const strengthText = document.getElementById(strengthTextId);

                if (!passwordInput || !strengthText) return;

                passwordInput.addEventListener('input', function () {
                    const val = passwordInput.value;
                    let strength = 0;

                    if (val.length >= 8) strength++;
                    if (/[A-Z]/.test(val)) strength++;
                    if (/[0-9]/.test(val)) strength++;
                    if (/[\W_]/.test(val)) strength++;

                    if (val.length === 0) {
                        strengthText.textContent = '';
                    } else if (strength <= 2) {
                        strengthText.textContent = 'Weak Password';
                        strengthText.style.color = 'red';
                    } else if (strength === 3) {
                        strengthText.textContent = 'Moderate Password';
                        strengthText.style.color = 'orange';
                    } else {
                        strengthText.textContent = 'Strong Password';
                        strengthText.style.color = 'green';
                    }
                });
            }

            function startOtpTimer(timerId, resendButtonId, duration = 30) {
                let timeLeft = duration;
                const timerElement = $(`#${timerId}`);
                const resendButton = $(`#${resendButtonId}`);

                resendButton.prop('disabled', true);

                const intervalId = setInterval(function () {
                    if (timeLeft <= 0) {
                        clearInterval(intervalId);
                        timerElement.text('0');
                        resendButton.prop('disabled', false);
                    } else {
                        timerElement.text(timeLeft);
                        timeLeft--;
                    }
                }, 1000);
            }

            // --- DESKTOP VIEW LOGIC ---
            if ($('#newPasswordDesktop').length) {
                updatePasswordStrength('newPasswordDesktop', 'passwordStrengthDesktop');
            }

            $('#sendOtpButtonDesktop').click(function (e) {
                const email = $('#emailDesktop').val();

                if (!email) {
                    showCustomModal('Please enter your email address.', 'error');
                    e.preventDefault();
                    return;
                }

                $(this).prop('disabled', true).text('Sending...');
                $('#forgotEmailFormDesktop').submit();
            });

            $('#resetPasswordButtonDesktop').click(function (e) {
                e.preventDefault();

                const email = $('input[name="email"][type="hidden"]').val();
                const otp = $('#otpDesktop').val();
                const newPassword = $('#newPasswordDesktop').val();
                const confirmNewPassword = $('#confirmNewPasswordDesktop').val();

                if (!otp || !newPassword || !confirmNewPassword) {
                    showCustomModal('All fields are required.', 'error');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    $('#passwordMismatchErrorDesktop').show();
                    return;
                } else {
                    $('#passwordMismatchErrorDesktop').hide();
                }

                $(this).prop('disabled', true).text('Resetting...');

                $.ajax({
                    url: '/forgot-password/reset-password',
                    type: 'POST',
                    data: JSON.stringify({
                        email: email,
                        otp: otp,
                        newPassword: newPassword,
                        confirmNewPassword: confirmNewPassword
                    }),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.success === 1) {
                            showCustomModal('Password reset successful! You can now log in with your new password.', 'success');
                            setTimeout(() => {
                                window.location.href = response.redirect || '/login';
                            }, 2000);
                        } else {
                            showCustomModal(response.message || 'Password reset failed. Please check your OTP and try again.', 'error');
                            $('#resetPasswordButtonDesktop').prop('disabled', false).text('Reset Password');
                        }
                    },
                    error: function () {
                        showCustomModal('An error occurred during password reset. Please try again.', 'error');
                        $('#resetPasswordButtonDesktop').prop('disabled', false).text('Reset Password');
                    }
                });
            });

            document.querySelectorAll('.toggle-password').forEach(icon => {
                const input = document.querySelector(icon.getAttribute('toggle'));
                if (input && input.type === 'password') {
                    icon.classList.add('fa-eye');
                } else {
                    icon.classList.add('fa-eye-slash');
                }
            
                icon.addEventListener('click', () => {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            });
            

            // --- MOBILE VIEW LOGIC ---
            if ($('#newPasswordMobile').length) {
                updatePasswordStrength('newPasswordMobile', 'passwordStrengthMobile');
            }

            $('#sendOtpButtonMobile').click(function (e) {
                const email = $('#emailMobile').val();

                if (!email) {
                    showCustomModal('Please enter your email address.', 'error');
                    e.preventDefault();
                    return;
                }

                $(this).prop('disabled', true).text('Sending...');
            });

            $('#resetPasswordButtonMobile').click(function (e) {
                e.preventDefault();

                const email = $('input[name="email"][type="hidden"]').val();
                const otp = $('#otpMobile').val();
                const newPassword = $('#newPasswordMobile').val();
                const confirmNewPassword = $('#confirmNewPasswordMobile').val();

                if (!otp || !newPassword || !confirmNewPassword) {
                    showCustomModal('All fields are required.', 'error');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    $('#passwordMismatchErrorMobile').show();
                    return;
                } else {
                    $('#passwordMismatchErrorMobile').hide();
                }

                $(this).prop('disabled', true).text('Resetting...');

                $.ajax({
                    url: '/forgot-password/reset-password',
                    type: 'POST',
                    data: JSON.stringify({
                        email: email,
                        otp: otp,
                        newPassword: newPassword,
                        confirmNewPassword: confirmNewPassword
                    }),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.success === 1) {
                            showCustomModal('Password reset successful! You can now log in with your new password.', 'success');
                            setTimeout(() => {
                                window.location.href = response.redirect || '/login';
                            }, 2000);
                        } else {
                            showCustomModal(response.message || 'Password reset failed. Please check your OTP and try again.', 'error');
                            $('#resetPasswordButtonMobile').prop('disabled', false).text('Reset Password');
                        }
                    },
                    error: function () {
                        showCustomModal('An error occurred during password reset. Please try again.', 'error');
                        $('#resetPasswordButtonMobile').prop('disabled', false).text('Reset Password');
                    }
                });
            });

            // --- Initialize Timer if on OTP step ---
            if ($('#timerDesktop').length && $('#timerDesktop').text() !== '0') {
                startOtpTimer('timerDesktop', 'resendOtpButtonDesktop');
            }
            if ($('#timerMobile').length && $('#timerMobile').text() !== '0') {
                startOtpTimer('timerMobile', 'resendOtpButtonMobile');
            }

            // --- Check for initial error messages from server and display with modal ---
            const serverErrorElement = document.querySelector('p.text-danger.mt-2');
            if (serverErrorElement && serverErrorElement.textContent.trim()) {
                showCustomModal(serverErrorElement.textContent.trim(), 'error');
                serverErrorElement.style.display = 'none';
            }
        });
    </script>
</body>
</html>