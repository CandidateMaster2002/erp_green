<%- include('../partials/headercode.ejs') %>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
        <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
        <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
        <style>
            /* new changes */

            #html-content {

                margin: 0;
                /* Center align */
            }


            @media (max-width: 767px) {
                #html-content {
                    width: 92%;
                    margin: 0 0;
                    /* Center align */
                }
            }

            .table-bordered th,
            .table-bordered td {
                padding: 3px;
                /* Adjust padding as needed */
                /*padding-left: 5px;*/
                /*padding-right: 5px;*/
                text-align: center;
                /* Center align text */
            }

            .table-bordered th {
                background-color: #f8f9fa;
                /* Optional: Add background color for headers */
                border-top: none;
            }

            .table-of-receipt th,
            .table-of-receipt td {
                padding: 0px;
                /* Adjust padding as needed */
                padding-left: 1px;
                padding-right: 1px;
                text-align: center;
                /* Center align text */
                margin: 0;
                padding-top: -5px;
                margin-top: -10px;

            }

            .btn-custom {
                flex: 1;
                /* Make the buttons take equal space */
                margin: 0 4px;
                /* Adjust the horizontal spacing */
                height: 40px;
                /* Set a fixed height for both buttons */
                display: flex;
                padding: 4px;
                align-items: center;
                /* Center the text vertically */
                justify-content: center !important;
                /* Center the text horizontally */
                white-space: nowrap;
                /* Prevent text from wrapping */
            }

            /* new changes */
            .frame1 {
                width: 55rem;
                height: 39rem;
                background: #FFF;
                padding: 15px;
            }

            .receipt-container {
                /* background-image: url("/images/receipt-bg3.png"); */
                padding-right: 15px;
                padding-left: 15px;
                margin-right: auto;
                margin-left: auto;

                position: relative;
                width: 50.2365rem;
                height: 35.97663rem;
                flex-shrink: 0;
                border: 0.2px solid #1E1E1E;
            }

            .shop-name {
                position: relative;
                display: flex;
                width: 16.20863rem;
                height: 1.2455rem;
                flex-direction: column;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 1.25rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;
            }

            .logo-container {
                display: flex;
                width: 7.625rem;
                height: 3.5rem;
                gap: 0.13638rem;
                flex-shrink: 0;

                color: #00ACC1;
            }

            .shop-info {
                margin-top: 0.48rem;
                width: 34.413rem;
                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 1rem;
            }

            .shop-info-child1 {
                display: flex;
                width: 12.21775rem;
                height: 2.80238rem;
                flex-direction: column;
                flex-shrink: 0;
            }

            .shop-info-child2 {
                width: 13.933rem;
                height: 2.86188rem;
                flex-shrink: 0;
            }

            .customer-details {
                width: 11.61225rem;
                height: 3.89913rem;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;

            }

            .customer-details p {
                display: flex;
                width: 11.61225rem;
                height: 0.78725rem;
                flex-direction: column;
                flex-shrink: 0;
                margin-top: 0.1rem;
                margin-bottom: 0;
            }

            .receipt-type {
                display: flex;
                width: 8.40925rem;
                height: 1.2455rem;
                flex-direction: column;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 1.25rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;
            }

            .receipt-details {
                width: 11.61225rem;
                height: 2.77413rem;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: normal;
            }

            .receipt-details p {
                display: flex;
                width: 11.61225rem;
                height: 0.78725rem;
                flex-direction: column;
                flex-shrink: 0;
                margin-top: 0.2rem;
                margin-bottom: 0;
            }

            .cart-table {
                position: relative;
                width: 50.2365rem;
                height: 14.56863rem;
                border: 0.05rem solid #1E1E1E;
                left: -1rem;
                margin-top: 0.75rem;
            }

            .cart-table thead th {
                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 600;
                line-height: normal;
                margin: auto;

                padding-right: 2rem;

                border: 0.05rem solid #1E1E1E;
            }

            .cart-table tbody td {
                border-left: 1px solid #000;
                border-right: 1px solid #000;
                border-top: none !important;

                padding-right: 2rem;

                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 0.875rem;
                text-transform: uppercase;
            }

            .footer-gst-distribution {
                position: relative;
                left: -1rem;
                width: 19.03875rem;
                height: 10rem;

                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 0.875rem;
                text-transform: uppercase;
            }

            .footer-gst-distribution thead th {
                color: #000;
                line-height: normal;
                margin: auto;
                border: 0.05rem solid #1E1E1E;
            }

            .footer-gst-distribution tbody td {
                border: 1px solid #000;
                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 0.875rem;
                text-transform: uppercase;
                padding-right: 0rem;
            }


            .footer-1 {
                position: relative;
                left: -1rem;
                top: -0.05rem;
                width: 35.9rem;
                height: 10.10rem;
                border: 0.05rem solid #1E1E1E;

                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
            }

            .receipt-msg {
                border-bottom: 0.05rem solid #1E1E1E;
                height: 1.76rem;
                font-weight: 300;
                line-height: normal;
            }

            .receipt-tnc {
                font-weight: 600;
                line-height: normal;
                margin-left: 0.34rem;
                margin-top: 0.47rem;

                height: 5.95rem;
            }


            .receipt-sign {
                border-top: 0.05rem solid #1E1E1E;
                width: 9.03875rem;
                font-weight: 600;
                line-height: normal;
                text-align: center;

                margin-left: auto;
                margin-bottom: 1rem;
            }

            .footer-2 {
                width: 13.25rem;
                height: 10.15rem;

                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
            }

            .cart-summary {
                height: 7.32rem;
                border-bottom: 0.05rem solid #1E1E1E;
            }

            .cart-summary .label {
                font-weight: 600;
            }

            .cart-total {
                font-size: 1rem;
                font-weight: 600;
            }

            .watermark,
            .watermark-receipt {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: rgba(255, 0, 0, 0.3);
                font-size: 5rem;
                z-index: 2;
                pointer-events: none;
            }

            @media (max-width: 768px) {
                .watermark {
                    font-size: 3rem;
                }
            }

            @media (max-width: 576px) {
                .watermark {
                    font-size: 2rem;
                }
            }
        </style>
    </head>

    <body>
        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar"
            style="background-image: linear-gradient(rgba(232, 231, 231, 0.5), rgba(232, 231, 231, 0.5)), url(/images/receipt-bg3.png);">
            <div class="layout-container">
                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">
                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">
                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">
                                    <div class="row invoice-preview  justify-content-center">

                                        <!-- Invoice responsive template -->

                                        <div class="col-xl-10 col-md-12 col-12 mb-md-0 mb-4 ml-4">
                                            <div class="card invoice-preview-card">
                                                <div class="watermark" style="display: none;"></div>
                                                <div class="card-body pb-0 text-center">
                                                    <h3 class="text-body fw-bold">Return Invoice</h3>
                                                    <hr class="my-0">
                                                </div>
                                                <div class="card-body">
                                                    <div
                                                        class="row flex-xl-row flex-md-column flex-sm-row flex-column p-sm-3 p-0">
                                                        <div class="col-xl-6 col-md-12 col-sm-5 col-12 mb-xl-0 mb-4">
                                                            <div class="d-flex mb-3 gap-2">
                                                                <span class="orgname fs-4 text-body fw-bold"></span>
                                                            </div>
                                                            <p class="mb-1 shopaddress"></p>
                                                        </div>
                                                        <div class="col-xl-6 col-md-12 col-sm-5 col-12 mt-2">

                                                            <div class="mb-0">
                                                                <span class="fw-medium dlno1"></span>
                                                            </div>
                                                            <div class="mb-0">
                                                                <span class="fw-medium dlno2"></span>
                                                            </div>
                                                            <div class="mb-0">
                                                                <span class="fw-medium flno"></span>
                                                            </div>
                                                            <div class="mb-0">
                                                                <span class="fw-medium gstin"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr class="my-0">
                                                <div class="card-body">
                                                    <div class="row p-sm-3 p-0">
                                                        <div
                                                            class="col-xl-6 col-md-12 col-sm-5 col-12 mb-xl-0 mb-md-4 mb-sm-0 mb-4">
                                                            <h6 class="pb-1">Invoice To:</h6>
                                                            <p class="mb-0 customername fw-bold"></p>
                                                            <p class="mb-0 shippingadd"></p>
                                                            <p class="mb-0 customermobile"></p>
                                                            <p class="mb-0 doctorname"></p>
                                                        </div>
                                                        <div class="col-xl-6 col-md-12 col-sm-7 col-12">
                                                            <h6 class="pb-1">Invoice Details:</h6>
                                                            <p class="mb-0 fw-bold salesinvoiceno"></p>
                                                            <p class="mb-0 fw-bold returninvoiceno"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table border-top m-0">
                                                        <thead>
                                                            <tr>
                                                                <th>Item</th>
                                                                <th>QTY</th>
                                                                <th>HSN</th>
                                                                <th>Batch</th>
                                                                <th>Exp.</th>
                                                                <th>MRP(₹)</th>
                                                                <th>GST%</th>
                                                                <th>Discount%</th>
                                                                <th>Total(₹)</th>

                                                            </tr>
                                                        </thead>
                                                        <tbody class="cartitems py-0 my-0">
                                                            <!-- <tr>
                                                                <td class="text-nowrap">Vuexy Admin </td>
                                                                <td class="text-nowrap">HTML </td>
                                                                <td>$32</td>
                                                                <td>1</td>
                                                                <td>$32.00</td>
                                                                <td></td>
                                                                <td></td>
                                                                <td></td>
                                                                <td>$32.00</td>
                                                            </tr> -->

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <!-- GST Distribution Table -- disabled  -->
                                                <div class="row card-body">
                                                    <!-- <div class="col-xl-8 col-md-12 col-sm-5 col-12 mb-xl-0 mb-md-4 mb-sm-0 mb-4">
                                                        <table class="table-bordered">
                                                            <thead>
                                                                <tr>
                                                                    <th>GST%</th>
                                                                    <th>Taxable Amt</th>
                                                                    <th>CGST</th>
                                                                    <th>SGST</th>
                                                                    <th>Total GST</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="p-0">
                                                                <tr>
                                                                    <td>0%</td>
                                                                    <td class="taxAmt0"></td>
                                                                    <td class="cgst-0"></td>
                                                                    <td class="sgst-0"></td>
                                                                    <td class="totalGst0"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>5%</td>
                                                                    <td class="taxAmt5"></td>
                                                                    <td class="cgst-5"></td>
                                                                    <td class="sgst-5">
                                                                    </td>
                                                                    <td class="totalGst5"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>12%</td>
                                                                    <td class="taxAmt12"></td>
                                                                    <td class="cgst-12"></td>
                                                                    <td class="sgst-12">
                                                                        </tdid>
                                                                    <td class="totalGst12"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>18%</td>
                                                                    <td class="taxAmt18"></td>
                                                                    <td class="cgst-18"></td>
                                                                    <td class="sgst-18">
                                                                        </tdid>
                                                                    <td class="totalGst18"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Total</td>
                                                                    <td class="taxAmtTotal"></td>
                                                                    <td class="cgstTotal"></td>
                                                                    <td class="sgstTotal"></td>
                                                                    <td class="totalGst"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div> -->
                                                    <div class="d-flex justify-content-end">
                                                        <table>
                                                            <tbody>
                                                                <tr class="pb-3 fs-5 fw-bold">
                                                                    <td class="pe-3">Sub Total (₹):</td>
                                                                    <td class="subtotal"></td>
                                                                </tr>

                                                                <tr class="pb-3 fs-5 fw-bold">
                                                                    <td class="pe-3">Return Amount(₹):</td>
                                                                    <td class="returnamount"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>


                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <span>“GET WELL SOON BY DAWA.AI”</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- /Invoice responsive template -->


                                        
                                        <!-- Invoice Actions -->
                                        <div class="col-xl-4 col-md-6 col-12 invoice-actions">
                                            <div class="pt-3">
                                                <div class="d-flex flex-md-row flex-column justify-content-center">
                                                    <div class="p-1">
                                                        <button id="printButton"
                                                            class="btn btn-primary btn-label-secondary d-grid w-100 mb-3 mx-1"
                                                            type="button">
                                                            Print
                                                        </button>
                                                    </div>
                                                    <div class="p-1">
                                                        <button
                                                            class="btn btn-primary btn-label-secondary btn-custom d-grid w-100 mb-3"
                                                            id="downloadButton">
                                                            Download
                                                        </button>
                                                    </div>
                                                    <!-- <div class="p-1">
                                                        <button class="btn btn-success btn-custom d-grid w-100 mb-3" type="button" id="whatsappLink">
                                                            WhatsApp
                                                        </button>
                                                    </div> -->
                                                    <div class="p-1" id="cancelReceipt">
                                                        <button class="btn btn-label-danger btn-custom d-grid w-100"
                                                            type="button" id="cancelReceipt">
                                                            Cancel Receipt
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- /Invoice Actions -->

                                    </div>

                                </div>
                                <!-- / Content -->
                            </div>
                    </div>
            </div>
        </div>

        <%- include('../partials/footercode.ejs') %>

            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

            <script>

                $(document).ready(function () {

                    var id = '<%=id%>';
                    var orgId = '<%=orgId%>';


                    $.get(`/api/v2/returnReceipt/${id}`, function (result, status) {
                        console.log(result.data);
                        const orgDetails = result.data.orgDetails;
                        const customerDetails = result.data.customerDetails;
                        const returnDetails = result.data.returnDetails;
                        const items = result.data.returnCartItems;

                        $(".orgname").text(orgDetails.org_name);

                        $(".shopaddress").html(`
                        ${orgDetails.org_address}</br>
                        ${orgDetails.org_city} (${orgDetails.org_state}), ${orgDetails.org_pincode}</br>
                        ${orgDetails.org_telephone}`)

                        $(".gstin").text(`GSTIN : ${orgDetails.org_gstin ? orgDetails.org_gstin : 'NA'}`);
                        $(".dlno1").text(`DL No 1: ${orgDetails.org_dl_no_1 ? orgDetails.org_dl_no_1 : 'NA'}`);
                        $(".dlno2").text(`DL No 2: ${orgDetails.org_dl_no_2 ? orgDetails.org_dl_no_2 : 'NA'}`)
                        $(".flno").text(`FSSAI : ${orgDetails.org_fssai_no ? orgDetails.org_fssai_no : 'NA'}`);


                        if (returnDetails.status === "cancelled" || returnDetails.return_status === "cancelled") {
                            $(".watermark, .watermark-receipt").text("CANCELLED").show();
                            $("#cancelReceipt").hide();
                        }

                        $(".customername").text(`Patient Name: ${customerDetails.cust_name ? customerDetails.cust_name : 'NA'}`);
                        $(".customermobile").text(`Mobile: ${customerDetails.cust_telephone ? customerDetails.cust_telephone : 'NA'}`);
                        $(".shippingadd").text(`Address: ${customerDetails.cust_address ? customerDetails.cust_address : 'NA'}`);

                        $(".salesinvoiceno").text(`Invoice no: ${returnDetails.invoice_id_main}`);
                        $(".returninvoiceno").text(`Return Invoice no: ${returnDetails.return_invoice_id}`);
                        $(".subtotal").text(returnDetails.return_subtotal);
                        $(".returnamount").text(returnDetails.return_amount);
                        $(".doctorname").text(`Doctor : ${returnDetails.doctor_name ? returnDetails.doctor_name : 'NA'}`);

                        // Display cart items
                        for (var i = 0; i < items.length; i++) {
                            var datetime = items[i].exp_date;
                            var date = moment(datetime).format('MM/YYYY');

                            cartHtml = `
                                <tr>
                                    <td style="width: 6.29rem; height: 1rem;">${items[i].product_name}</td>
                                    <td style="width: 3.1rem; height: 1rem;">${items[i].return_pri_qty}:${items[i].return_sec_qty}</td>
                                    <td style="width: 4.59rem; height: 1rem;">${items[i].hsn}</td>
                                    <td style="width: 4.4rem; height: 1rem;">${items[i].batch_name}</td>
                                    <td style="width: 3.25rem; height: 1rem;">${date}</td>
                                    <td style="width: 3.62rem; height: 1rem;">${items[i].return_mrp}</td>
                                    <td style="width: 3.61rem; height: 1rem;">${items[i].gst}</td>
                                    <td style="width: 2.91rem; height: 1rem;">${items[i].return_dis}</td>
                                    <td style="width: 4.2rem; height: 1rem;">${items[i].return_total}</td>
                                </tr>`
                            $(".cartitems").append(cartHtml);
                        }
                    });


                    $('#downloadButton').click(function () {
                        $.ajax({
                            url: `/api/v2/returnReceipt/${id}/pdf`,
                            method: 'GET',
                            xhrFields: {
                                responseType: 'blob' // Important for binary data
                            },
                            success: function (data) {
                                var blob = new Blob([data], { type: 'application/pdf' });
                                var link = document.createElement('a');
                                link.href = window.URL.createObjectURL(blob);
                                link.download = 'return-receipt.pdf';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            },
                            error: function (err) {
                                console.error('Error downloading the receipt:', err);
                            }
                        });
                    });

                    $('#printButton').click(function () {
                        $.ajax({
                            url: `/api/v2/returnReceipt/${id}/pdf`,
                            method: 'GET',
                            xhrFields: {
                                responseType: 'blob' // Important for binary data
                            },
                            success: function (data) {
                                var blob = new Blob([data], { type: 'application/pdf' });
                                var url = window.URL.createObjectURL(blob);
                                var printWindow = window.open(url, '_blank', 'width=800,height=600');
                                printWindow.onload = function () {
                                    printWindow.print();
                                }
                            },
                            error: function (err) {
                                console.error('Error downloading the receipt:', err);
                            }
                        });
                    });

                    //Return cancellation button
                    $('#cancelReceipt').on('click', function (e) {
                        e.preventDefault(); // Prevent the default action
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, cancel it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Perform the cancellation action here
                                $.get(`/api/cancelReturnInvoice?returnId=${id}&orgId=<%=orgId%>`, function (data) {
                                    if (data.success == 1) {
                                        $.get(`/api/updatebatchoncancelreturninvoice?returnId=${id}`, function (updateData) {
                                            if (updateData.success == 1) {
                                                $.get(`/api/updatecartoncancelreturninvoice?returnId=${id}`, function (updateStockData) {
                                                    if (updateStockData.success == 1) {
                                                        Swal.fire(
                                                            'Cancelled!',
                                                            'The receipt has been cancelled.',
                                                            'success'
                                                        ).then(() => {
                                                            location.reload();
                                                        })
                                                    } else {
                                                        Swal.fire(
                                                            'Stock Error!',
                                                            'There was an error cancelling the receipt.',
                                                            'error'
                                                        )
                                                    }
                                                });
                                            } else {
                                                Swal.fire(
                                                    'batch Error!',
                                                    'There was an error cancelling the receipt.',
                                                    'error'
                                                )
                                            }
                                        });
                                    } else {
                                        Swal.fire(
                                            'Error!',
                                            'There was an error cancelling the receipt.',
                                            'error'
                                        )
                                    }
                                })
                            }
                        })
                    });

                });
            </script>
    </body>

    </html>