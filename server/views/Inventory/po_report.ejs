<%- include('../partials/headercode.ejs') %>

  <body>

    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar  ">
      <div class="layout-container">

        <!-- sidebar imported -->
        <%- include('../partials/sidebar.ejs') %>

          <!-- Layout container -->
          <div class="layout-page">

            <!-- navbar imported -->
            <%- include('../partials/navbar.ejs') %>

              <!-- Content wrapper -->
              <div class="content-wrapper">

                <!-- Content -->

                <div class="container-xxl flex-grow-1 container-p-y">

                  <h4 class="fw-bold py-3 mb-1"> Purchase Order Report</h4>
                  <hr class="mb-4">


                  <!--  -->
                  <div>
                    <div class="card mb-4" id="date-range-filter">
                      <div class="row align-items-center flex ">
                        <div class="col-md-2  text-center">
                          <!-- <div class="card-header mb-2">From Date</div> -->
                          <h5 class="card-header mb-2">From Date</h5>
                        </div>
                        <div class="col-md-4 ">
                          <div class="card-header">
                            <input class="form-control" type="date"  id="from-date-input" name="fromdate" />
                          </div>
                        </div>
                        <div class="col-md-2 text-center">
                          <h5 class="card-header mb-2">To Date</h5>
                        </div>
                        <div class="col-md-4 ">
                          <div class="card-header">
                            <input class="form-control" type="date" id="to-date-input" name="todate" />
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card mb-4">
                      <div class="row">
                        <div class="col-md-3 text-center">
                          <h5 class="card-header"><input type="radio" name="radio" value="daterange" checked> Date Range</h5>
                        </div>
                        <div class="col-md-3 text-center">
                          <h5 class="card-header"><input type="radio" name="radio" value="monthly"> Monthly</h5>
                        </div>
                        <div class="col-md-3 text-center">
                          <h5 class="card-header"><input type="radio" name="radio" value="quarterly"> Quarterly</h5>
                        </div>
                        <div class="col-md-3 text-center">
                          <h5 class="card-header"><input type="radio" name="radio" value="yearly"> Yearly</h5>
                        </div>
                      </div>

                      <div id="dropdown"></div>
                    </div>

                  </div>


                  <!--  -->
                  <div class="text-center mb-4">
                    <button type="button" class="btn btn-primary" id="generatepurchasereport">Generate Report</button>
                  </div>

                  <!-- PO List -->
                  <div class="card mx-3">
                    <h5 class="card-header">PO List</h5>
                    <div class="card-body">
                      <div class="table-responsive text-nowrap">
                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>PO Id</th>
                              <th>Generation Date</th>
                              <th>Time</th>
                              <th>Vendor Name</th>
                              <th class="text-end">Amount</th> 
                                            

                            </tr>
                          </thead>
                          <tbody id="reportcart">


                            <!-- <tr>
                                            <td>2</td>
                                            <td>19772</td>
                                            <td>20/03/2023</td>
                                            <th>Uday Aggarwal</th>
                                            <td>11/04/2023</td>
                                            <td><span class="badge bg-label-success me-1">Completed</span></td>
                                        </tr>

                                        <tr>
                                            <td>2</td>
                                            <td>17822</td>
                                            <td>26/03/2023</td>
                                            <th>Kartik Kondu</th>
                                            <td>25/04/2023</td>
                                            <td><span class="badge bg-label-warning me-1">Pending</span></td>
                                        </tr> -->

                          </tbody>
                        </table>
                      </div>
                      <div class="table-footer bg-light position-sticky" style="bottom: 0;">
                        <table class="table">
                          <tfoot>
                            <tr class="table-success">
                              <td class="h5 ps-5">Total PURCHASE AMOUNT</td>
                              <td class="h5 text-end" id="totalPurchaseAmount"></td> <!-- Total cost here -->
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </div>
                  </div>

                  <!-- / PO List -->
                   <!-- NEW: Chart Section for PO -->
                  <div class="card mt-4 mb-4">
                    <h5 class="card-header">Purchase Order Overview Chart</h5>
                    <div class="card-body">
                      <canvas id="poChart"></canvas> <!-- Unique ID for PO chart -->
                    </div>
                  </div>
                  <!-- / Chart Section -->

                </div>
              </div>
              <!-- / Content -->

              <div class="content-backdrop fade"></div>
          </div>
          <!-- Content wrapper -->
      </div>
      <!-- / Layout page -->
    </div>



    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>


    </div>
    <!-- / Layout wrapper -->

    <%- include('../partials/footercode.ejs') %>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

      <script>
        // Declare a global variable to hold the Chart.js instance for Purchase Order reports.
        let myPurchaseChart;

        // Function: $(document).ready - START
        $(document).ready(function () {
          // console.log("Purchase Order Report Script loaded and starting..."); // Debug log

          // Consistently define today's date components for initial setup
          const today = new Date();
          const dd = String(today.getDate()).padStart(2, '0');
          const mm = String(today.getMonth() + 1).padStart(2, '0');
          const currentFullYear = today.getFullYear();

          // Function: populateYearDropdown - START
          // Helper function to populate year dropdowns dynamically
          function populateYearDropdown(selectorId) {
            const dynamicCurrentYear = new Date().getFullYear();
            $(selectorId).empty().append('<option selected value="">Please Select</option>');
            for (let i = -5; i <= 5; i++) { // Populate years from 5 years ago to 5 years from now
              const year = dynamicCurrentYear + i;
              $(selectorId).append(`<option value="${year}">${year}</option>`);
            }
            $(selectorId).val(dynamicCurrentYear); // Set current year as default selected
          }
          // Function: populateYearDropdown - END

          // Function: getXAxisLabel - START
          // Helper function to determine the appropriate X-axis label based on the selected filter type
          function getXAxisLabel(filterType) {
            if (filterType === 'monthly' || filterType === 'daterange') return 'Date';
            if (filterType === 'quarterly') return 'Quarter / Year';
            if (filterType === 'yearly') return 'Month / Year';
            return 'Period';
          }
          // Function: getXAxisLabel - END

          // Function: renderPurchaseChart - START
          /**
           * Renders or updates the Purchase Order chart based on the provided PO data.
           * Aggregates data by the relevant period and draws a Chart.js graph.
           * @param {Array<Object>} poItems - The array of Purchase Order objects.
           * @param {string} filterType - The type of filter applied ('daterange', 'monthly', 'quarterly', 'yearly').
           */
          function renderPurchaseChart(poItems, filterType) {
            const ctx = document.getElementById('poChart');

            if (!ctx) {
              console.error("ERROR: Canvas element with ID 'poChart' not found!");
              return;
            }

            // Destroy any existing chart instance before drawing a new one
            if (myPurchaseChart) {
              myPurchaseChart.destroy();
              // console.log("Existing Purchase Order chart destroyed."); // Debug log
            }

            // If no PO items, clear chart and return
            if (!poItems || poItems.length === 0) {
              myPurchaseChart = null;
              // console.log("No PO items to render chart."); // Debug log
              return;
            }

            // --- Data Aggregation for Chart ---
            let aggregatedData = {};
            let chartType = 'bar'; // Default chart type

            poItems.forEach(item => {
              let key;
              const poDate = moment(item.po_created_date); // Use 'po_created_date' for PO items

              // Ensure item.po_total_amount exists and is a number
              const totalAmt = parseFloat(item.po_total_amount || 0);

              // Determine aggregation key and chart type based on filter
              if (filterType === 'monthly' || filterType === 'daterange') {
                key = poDate.format('YYYY-MM-DD');
                chartType = 'line'; // Line chart for daily trends
              } else if (filterType === 'quarterly') {
                const year = poDate.year();
                const month = poDate.month() + 1;
                let quarter;
                // Assuming April-March financial year
                if (month >= 4 && month <= 6) { quarter = 'Q1'; }
                else if (month >= 7 && month <= 9) { quarter = 'Q2'; }
                else if (month >= 10 && month <= 12) { quarter = 'Q3'; }
                else { quarter = 'Q4'; }
                key = `${year} ${quarter}`;
                chartType = 'bar'; // Bar chart for quarterly sums
              } else if (filterType === 'yearly') {
                key = poDate.format('YYYY-MM'); // Aggregate by month for yearly view
                chartType = 'line'; // Line chart for monthly trends within a year
              } else {
                key = poDate.format('YYYY-MM-DD'); // Fallback to daily if filter type is unknown
                chartType = 'line';
              }

              if (!aggregatedData[key]) {
                aggregatedData[key] = 0;
              }
              aggregatedData[key] += totalAmt;
            });

            const sortedKeys = Object.keys(aggregatedData).sort();

            const labels = sortedKeys.map(key => {
              if (filterType === 'monthly' || filterType === 'daterange') {
                return moment(key).format('MMM D, YYYY'); // e.g., Jan 1, 2024
              } else if (filterType === 'yearly') {
                return moment(key).format('MMM YYYY'); // e.g., Jan 2024
              }
              return key; // For quarterly, return as '2024 Q1'
            });

            const dataValues = sortedKeys.map(key => aggregatedData[key].toFixed(2));

            // --- Chart.js Configuration and Initialization ---
            myPurchaseChart = new Chart(ctx, {
              type: chartType,
              data: {
                labels: labels,
                datasets: [{
                  label: 'Total Purchase Order Amount (₹)',
                  data: dataValues,
                  // Use a distinct color for PO charts (e.g., a shade of purple or orange)
                  backgroundColor: chartType === 'bar' ? 'rgba(153, 102, 255, 0.8)' : 'rgba(153, 102, 255, 0.4)', // Purple
                  borderColor: 'rgba(153, 102, 255, 1)',
                  borderWidth: 1,
                  fill: chartType === 'line' ? true : false,
                  tension: chartType === 'line' ? 0.4 : 0
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: `Purchase Order Overview: ${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`
                  },
                  legend: {
                    display: true,
                    position: 'top'
                  }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: getXAxisLabel(filterType)
                    }
                  },
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Amount (₹)'
                    }
                  }
                }
              }
            });
            // console.log("Purchase Order chart initialization attempt complete."); // Debug log
          }
          // Function: renderPurchaseChart - END

          // --- Initial setup for default date range and filter display on page load ---
          // Set initial dates for the 'From Date' and 'To Date' inputs to today
          $("#from-date-input").val(`${currentFullYear}-${mm}-${dd}`);
          $("#to-date-input").val(`${currentFullYear}-${mm}-${dd}`);

          // Hide the dynamic dropdown container initially and show date range filter
          $("#dropdown").empty();
          $('#date-range-filter').show();
          $('input[name="radio"][value="daterange"]').prop('checked', true); // Set Date Range as default checked

          // Handle URL parameter for 'currentFY' (Current Financial Year) - if applicable for PO
          var urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('filter') == 'currentFY') {
            const fyCurrentYear = new Date().getFullYear();
            const fyCurrentMonth = new Date().getMonth();

            let fyStartYear;
            let fyEndYear;

            if (fyCurrentMonth < 3) { // If the current month is before April (Jan, Feb, Mar)
              fyStartYear = fyCurrentYear - 1; // FY starts last year
              fyEndYear = fyCurrentYear;
            } else { // If the current month is April or later
              fyStartYear = fyCurrentYear; // FY starts this year
              fyEndYear = fyCurrentYear + 1;
            }

            const fyStartDate = `${fyStartYear}-04-01`; // April 1st
            const fyEndDate = `${fyEndYear}-03-31`; // March 31st of next calendar year

            $("#from-date-input").val(fyStartDate);
            $("#to-date-input").val(fyEndDate);

            $('input[name="radio"][value="daterange"]').prop('checked', true); // Ensure daterange is selected
            $('#date-range-filter').show(); // Ensure date inputs are visible
            $("#dropdown").empty(); // Clear any dynamically added dropdowns

            // Automatically generate report for FY if URL param is present
            generatePurchaseReport();
          }

          // Event Handler: $('input[name="radio"]').on('click') - START
          // Unified event handler for all radio button clicks
          $('input[name="radio"]').on('click', function () {
            // console.log("Radio button clicked. Value:", $(this).val()); // Debug log
            const selectedValue = $(this).val();

            // Hide all potential filter sections first, clear table and total
            $('#date-range-filter').hide();
            $("#dropdown").empty(); // Clear dynamic dropdowns
            $("#reportcart").empty(); // Clear table
            $("#totalPurchaseAmount").text(`₹0.00`); // Reset total purchase amount

            // Destroy the chart when the filter type changes
            if (myPurchaseChart) {
              myPurchaseChart.destroy();
              myPurchaseChart = null;
              // console.log("Existing Purchase Order chart destroyed."); // Debug log
            }

            // Show appropriate filter inputs and populate dropdowns
            if (selectedValue === 'daterange') {
              $('#date-range-filter').show();
              // Reset date inputs to today's date
              $("#from-date-input").val(`${currentFullYear}-${mm}-${dd}`);
              $("#to-date-input").val(`${currentFullYear}-${mm}-${dd}`);
            } else if (selectedValue === 'monthly') {
              $("#dropdown").html(`
                  <div class="card-body">
                      <div class="row justify-content-center">
                          <div class="col-md-6 col-12 text-center mb-2">
                              <select class="form-select" id="selectmonth" aria-label="Default select example">
                                  <option selected value="">Please Select</option>
                                  <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                                  <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                                  <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                                  <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                              </select>
                          </div>
                          <div class="col-md-6 col-12 text-center mb-2">
                              <select class="form-select" id="month-selectyear" aria-label="Default select example"></select>
                          </div>
                      </div>
                  </div>
              `);
              populateYearDropdown('#month-selectyear');
              $('#selectmonth').val(new Date().getMonth() + 1); // Set current month as default
            } else if (selectedValue === 'quarterly') {
              $("#dropdown").html(`
                  <div class="card-body">
                      <div class="row justify-content-center">
                          <div class="col-md-6 col-12 text-center mb-2">
                              <select class="form-select" id="selectquarter" aria-label="Default select example">
                                  <option selected value="">Please Select</option>
                                  <option value="1">April-June (Q1)</option>
                                  <option value="2">July-Sept (Q2)</option>
                                  <option value="3">Oct-Dec (Q3)</option>
                                  <option value="4">Jan-March (Q4)</option>
                              </select>
                          </div>
                          <div class="col-md-6 col-12 text-center mb-2">
                              <select class="form-select" id="quarter-selectyear" aria-label="Default select example"></select>
                          </div>
                      </div>
                  </div>
              `);
              populateYearDropdown('#quarter-selectyear');
              // Set default quarter based on current month for FY (April-March)
              const currentMonth = new Date().getMonth() + 1;
              if (currentMonth >= 4 && currentMonth <= 6) $('#selectquarter').val('1');
              else if (currentMonth >= 7 && currentMonth <= 9) $('#selectquarter').val('2');
              else if (currentMonth >= 10 && currentMonth <= 12) $('#selectquarter').val('3');
              else if (currentMonth >= 1 && currentMonth <= 3) $('#selectquarter').val('4');
            } else if (selectedValue === 'yearly') {
              $("#dropdown").html(`
                  <div class="card-body">
                      <div class="col-md-12 text-center mb-2">
                          <select class="form-select" id="selectyear" aria-label="Default select example" style="width: 100%;"></select>
                      </div>
                  </div>
              `);
              populateYearDropdown('#selectyear');
            }
            // Generate report immediately after filter type change if all conditions are met
            // This prevents waiting for the "Generate Report" button if a dropdown selection is default
            
          });
          // Event Handler: $('input[name="radio"]').on('click') - END

          // Event Handler: Delegated change listeners for dynamic dropdowns - START
          // These listeners will trigger the report generation when selections in dynamic dropdowns change.
          
          // Event Handler: Delegated change listeners for dynamic dropdowns - END

          // Function: generatePurchaseReport - START
          // Main function to generate the Purchase Order report based on selected filters
          function generatePurchaseReport() {
            // console.log("generatePurchaseReport function called."); // Debug log
            let apiUrl = `/api/v2/purchaseOrders?orgId=<%=orgId%>`; // API endpoint for Purchase Orders
            const selectedFilterType = $('input[name="radio"]:checked').val();
            // console.log("Selected Filter Type for PO:", selectedFilterType); // Debug log

            if (!selectedFilterType) {
              console.warn("No filter type selected for Purchase Order report.");
              return;
            }

            // Build the API URL based on the selected filter type and its inputs
            if (selectedFilterType === 'daterange') {
              const fromDate = $("#from-date-input").val();
              const toDate = $("#to-date-input").val();
              // console.log("Date Range for PO: From", fromDate, "To", toDate); // Debug log
              if (!fromDate || !toDate) {
                console.warn("Dates missing for daterange filter in PO report.");
                $("#reportcart").empty().append('<tr><td colspan="6" class="text-center">Please select both From Date and To Date.</td></tr>');
                $("#totalPurchaseAmount").text(`₹0.00`);
                if (myPurchaseChart) { myPurchaseChart.destroy(); myPurchaseChart = null; }
                return;
              }
              apiUrl += `&startDate=${fromDate}&endDate=${toDate}`;
            } else if (selectedFilterType === 'monthly') {
              const month = $('#selectmonth').val();
              const year = $('#month-selectyear').val();
              if (!month || !year) {
                console.warn("Month or Year missing for monthly filter in PO report.");
                $("#reportcart").empty().append('<tr><td colspan="6" class="text-center">Please select a Month and Year.</td></tr>');
                $("#totalPurchaseAmount").text(`₹0.00`);
                if (myPurchaseChart) { myPurchaseChart.destroy(); myPurchaseChart = null; }
                return;
              }
              apiUrl += `&month=${month}&year=${year}`;
            } else if (selectedFilterType === 'quarterly') {
              const quarter = $('#selectquarter').val();
              const year = $('#quarter-selectyear').val();
              if (!quarter || !year) {
                console.warn("Quarter or Year missing for quarterly filter in PO report.");
                $("#reportcart").empty().append('<tr><td colspan="6" class="text-center">Please select a Quarter and Year.</td></tr>');
                $("#totalPurchaseAmount").text(`₹0.00`);
                if (myPurchaseChart) { myPurchaseChart.destroy(); myPurchaseChart = null; }
                return;
              }
              apiUrl += `&quarter=${quarter}&year=${year}`;
            } else if (selectedFilterType === 'yearly') {
              const year = $('#selectyear').val();
              if (!year) {
                console.warn("Year missing for yearly filter in PO report.");
                $("#reportcart").empty().append('<tr><td colspan="6" class="text-center">Please select a Year.</td></tr>');
                $("#totalPurchaseAmount").text(`₹0.00`);
                if (myPurchaseChart) { myPurchaseChart.destroy(); myPurchaseChart = null; }
                return;
              }
              apiUrl += `&year=${year}`;
            }

            // console.log("API URL for PO to be called:", apiUrl); // Debug log
            // Perform the AJAX GET request to the constructed API URL
            $.get(apiUrl, function (data, status) {
              console.log("AJAX Success for PO! Data:", data, "Status:", status);
              $("#reportcart").empty(); // Clear existing report data
              let totalPurchaseAmount = 0; // Initialize total for Purchase Order

              // --- CRITICAL FIX: Access the nested 'data.data.data.data' property from the backend response ---
              // Assuming same nesting as GRN. If not, debug using console.logs as before.
              if (data.data && data.data.data && data.data.data.data && data.data.data.data.data && data.data.data.data.data.length > 0) {
                var items = data.data.data.data.data; // PROBABLE CORRECT ACCESS: Assuming data is nested 3 levels deep
                console.log("Purchase Order Items for table and chart (from data.data.data.data):", items);
                console.log("Number of items:", items.length);

                for (let i = 0; i < items.length; i++) {
                  // Ensure 'po_total_amount' exists in your dummy data for PO
                  const poAmt = parseFloat(items[i].po_total_amount || 0); // Use 0 if undefined
                  totalPurchaseAmount += poAmt; // Sum up PO amounts

                  var datetime = items[i].po_created_date; // Use 'po_created_date' property for PO
                  var date = moment(datetime).format('DD MMMM YYYY'); // Formatted date
                  var time = moment(datetime).utcOffset('+05:30'); // Assuming IST
                  var localTime = time.format('hh:mm A'); // Formatted time

                  var htmlData = `
                    <tr>
                      <td>${i + 1}</td>
                      <td><a href="/po_receipt/${items[i].po_id_main}" ><strong>${items[i].po_id_main}</strong></a></td>
                      <td>${date}</td>
                      <td>${localTime}</td>
                      <td>${items[i].vendor_name}</td>
                      <td class="text-end">₹${poAmt.toFixed(2)}</td>
                    </tr>
                  `;
                  $("#reportcart").append(htmlData);
                  // console.log(`Appended PO row ${i + 1}: ${htmlData.trim().substring(0, 50)}...`); // Debug log
                }
                $("#totalPurchaseAmount").text(`₹${totalPurchaseAmount.toFixed(2)}`); // Update total PO amount display
                // console.log("Total Purchase Order Amount updated to:", `₹${totalPurchaseAmount.toFixed(2)}`); // Debug log

                // Render the Purchase Order chart with the fetched data
                renderPurchaseChart(items, selectedFilterType);
                // console.log("Purchase Order chart rendering initiated."); // Debug log

              } else {
                console.log("No Purchase Order data found for the selected period (else block triggered).");
                $("#reportcart").empty().append('<tr><td colspan="6" class="text-center">No Purchase Order data found for the selected period.</td></tr>');
                $("#totalPurchaseAmount").text(`₹0.00`); // Reset total PO amount

                // Clear the chart if no data is found
                if (myPurchaseChart) {
                  myPurchaseChart.destroy();
                  myPurchaseChart = null;
                  // console.log("Purchase Order chart destroyed due to no data."); // Debug log
                }
              }
            }).fail(function (jqXHR, textStatus, errorThrown) {
              console.error("AJAX Error for PO! Text Status:", textStatus, "Error Thrown:", errorThrown, "JQ XHR:", jqXHR);
              $("#reportcart").empty().append('<tr><td colspan="6" class="text-center text-danger">Error loading Purchase Order report. Please try again.</td></tr>');
              $("#totalPurchaseAmount").text(`₹0.00`);
              if (myPurchaseChart) {
                myPurchaseChart.destroy();
                myPurchaseChart = null;
                // console.log("Purchase Order chart destroyed due to AJAX error."); // Debug log
              }
            });
          }
          // Function: generatePurchaseReport - END

          // Event Handler: $("#generatepurchasereport").click() - START
          // Attach click handler to the "Generate Report" button for Purchase Order
          $("#generatepurchasereport").click(function () {
            // console.log("Generate Purchase Order Report button clicked."); // Debug log
            generatePurchaseReport();
          });
          // Event Handler: $("#generatepurchasereport").click() - END
        });
        // Function: $(document).ready - END
      </script>
      

      <style>
        @media (max-width: 767px) {

          .card-body.d-flex .row.w-100 {
            flex-direction: row;
            /* Ensure row direction */
            justify-content: start;
            /* Center the content */
            align-items: flex-start;
          }

          .col-6 {
            flex: 0 0 50%;
            /* Make each input take up 50% of the width */
            max-width: 50%;

          }

          .text-center select {
            width: 100%;
            /* Ensure the select input takes full width */
          }

          .card-header {
            font-size: 0.75em;
            /* Adjust the font size as needed */
            display: flex;
            justify-content: flex-start;
            /* Align content to the left */
            align-items: flex-start;
            padding: 10px;
          }

          .card-header input {
            margin-right: 0.5rem;
          }
        }
      </style>

  </body>


  </html>